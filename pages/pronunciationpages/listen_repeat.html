<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listen and Repeat</title>
    <link rel="stylesheet" href="../../files/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Nunito', sans-serif;
            background-color: #f0f8ff; /* Light, friendly blue */
        }
        .go-back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            text-decoration: none;
            font-size: 1.2rem;
            color: var(--primary-color, #0056b3);
        }
        .activity-container {
            display: flex;
            gap: 20px;
            margin-top: 60px;
            width: 90%;
            max-width: 800px;
        }
        .card {
            flex: 1;
            background-color: #fff;
            border-radius: var(--border-radius, 15px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }
        #word-display {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 3rem;
            color: var(--primary-color, #0056b3);
        }
        .icon-btn:hover {
            color: #007bff;
        }
        #mic-btn.listening .fa-microphone {
            animation: pulse 1.5s infinite;
        }
        .feedback-container {
            margin-top: 20px;
            font-size: 1.5rem;
        }
        #message-container {
            margin-top: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            min-height: 50px;
        }
        .message-correct {
            color: #28a745;
        }
        .message-error {
            color: #dc3545;
        }
        .message-countdown {
            color: #17a2b8;
        }
        .final-completion {
            animation: glow 2s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #007bff, 0 0 40px #007bff; }
            to { text-shadow: 0 0 20px #fff, 0 0 30px #007bff, 0 0 40px #007bff, 0 0 50px #007bff; }
        }

        @media (max-width: 768px) {
            .activity-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <a href="../pronunciation.html" class="go-back-link">Go back to Pronunciation</a>
    <div class="activity-container">
        <div class="card listen-card">
            <h2 id="word-display">Word</h2>
            <button id="listen-btn" class="icon-btn">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>
        <div class="card pronunciation-card">
            <button id="mic-btn" class="icon-btn">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>
    <div class="feedback-container">
        <p>Right now you are saying: <span id="feedback-text">-</span></p>
    </div>
    <div id="message-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const words = [
                'apple', 'book', 'car', 'dog', 'eye', 'fish', 'girl', 'house', 'ice', 'jump',
                'kite', 'lemon', 'mouse', 'nose', 'orange', 'pencil', 'queen', 'red', 'sun', 'tree',
                'umbrella', 'violet', 'water', 'yellow', 'zebra', 'one', 'two', 'three', 'four', 'five'
            ];

            let shuffledWords = [];
            let currentWordIndex = 0;
            let recognition;
            let timeoutId;

            const wordDisplay = document.getElementById('word-display');
            const listenBtn = document.getElementById('listen-btn');
            const micBtn = document.getElementById('mic-btn');
            const feedbackText = document.getElementById('feedback-text');
            const messageContainer = document.getElementById('message-container');
            const activityContainer = document.querySelector('.activity-container');

            const audio = new Audio('../../files/audio/apple.mp3');

            // Speech Recognition setup
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.continuous = false;
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0])
                        .map(result => result.transcript)
                        .join('');

                    feedbackText.textContent = transcript || '-';

                    if (event.results[0].isFinal) {
                        checkAnswer(transcript.toLowerCase().trim());
                    }
                };

                recognition.onerror = (event) => {
                    displayMessage(`Speech recognition error: ${event.error}`, 'error');
                    stopListening();
                    micBtn.disabled = false;
                };

                recognition.onend = () => {
                    stopListening();
                    micBtn.disabled = false;
                };

            } else {
                displayMessage('Speech recognition not supported in this browser.', 'error');
                micBtn.disabled = true;
            }

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function startGame() {
                shuffledWords = shuffle([...words]);
                currentWordIndex = 0;
                displayNextWord();
            }

            function displayNextWord() {
                if (currentWordIndex < shuffledWords.length) {
                    wordDisplay.textContent = shuffledWords[currentWordIndex];
                    feedbackText.textContent = '-';
                    messageContainer.innerHTML = '';
                    micBtn.disabled = false;
                } else {
                    showCompletionMessage();
                }
            }

            function showCompletionMessage() {
                activityContainer.style.display = 'none';
                feedbackText.textContent = '-';
                messageContainer.innerHTML = `<span class="final-completion">You completed the activity!</span>`;
            }

            function displayMessage(text, type) {
                const className = type === 'correct' ? 'message-correct' :
                                  type === 'error' ? 'message-error' : 'message-countdown';
                messageContainer.innerHTML = `<p class="${className}">${text}</p>`;
            }

            function startListening() {
                if (!recognition) return;

                micBtn.classList.add('listening');
                micBtn.disabled = true;
                feedbackText.textContent = '...';
                recognition.start();

                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    recognition.stop();
                    displayMessage('Try Again!', 'error');
                    micBtn.disabled = false;
                }, 20000); // 20-second timer
            }

            function stopListening() {
                if (!recognition) return;
                micBtn.classList.remove('listening');
                clearTimeout(timeoutId);
            }

            function checkAnswer(transcript) {
                const currentWord = shuffledWords[currentWordIndex].toLowerCase();
                if (transcript === currentWord) {
                    clearTimeout(timeoutId);
                    recognition.stop();
                    displayMessage("That's Right!", 'correct');

                    let countdown = 3;
                    const countdownInterval = setInterval(() => {
                        displayMessage(`Get ready for next one: ${countdown}...`, 'countdown');
                        countdown--;
                        if (countdown < 0) {
                            clearInterval(countdownInterval);
                            currentWordIndex++;
                            displayNextWord();
                        }
                    }, 1000);

                }
            }

            listenBtn.addEventListener('click', () => {
                audio.play();
            });

            micBtn.addEventListener('click', startListening);

            startGame();
        });
    </script>
</body>
</html>
